from __future__ import print_function
"""
Try to identify a pseudocontinuum zone
"""
import pyspeckit
from astropy import units as u
import numpy as np
import scipy.ndimage
import pylab as pl

from astropy import log
#log.setLevel(10)

for spw in range(4):

    sp = pyspeckit.Spectrum('e8mm_spw{0}_mean.fits'.format(spw))
    sp.plotter(figure=pl.figure(1))
    sp.baseline.includemask &= (sp.data > 0.25) & (sp.data < 0.35)
    sp.baseline.highlight_fitregion()
    sp.baseline(order=1, subtract=False, reset=False,
                highlight_fitregion=False, reset_selection=False,
                selectregion=False)
    sp.baseline(order=1, subtract=True, reset=False, highlight_fitregion=False,
                reset_selection=False, selectregion=False)

    pl.figure(2)
    pl.clf()
    pl.hist(sp.data[~sp.data.mask], bins=np.linspace(-1,1))

    continua = (np.abs(sp.data)<0.05)
    print("N_continua: {0} = {1}%".format(continua.sum(),
                                          float(continua.sum())/continua.size*100))
    labels, nlabels = (scipy.ndimage.measurements.label(continua))
    # Llabels = line labels
    Llabels, nLlabels = (scipy.ndimage.measurements.label(~continua))
    bands = ''
    fbands = ''
    linebands = ''
    xarr = sp.xarr.as_unit(u.GHz)
    for ii in range(1, nlabels+1):
        #x = np.where(labels == ii)
        # select the stuff we want to flag out
        x = np.where(Llabels == ii)
        if len(x[0]) > 5:
            #print "{0}: {1}-{2}".format(ii,x[0][0], x[0][-1])
            bands = bands + ",{spw}:{0}~{1}".format(x[0][0], x[0][-1], spw=spw)
            fbands = fbands + ",{spw}:{0}~{1}GHz".format(xarr[x[0][0]].value, xarr[x[0][-1]].value, spw=spw)
            #sp.data.mask[x[0][0]:x[0][-1]] = True
            #spn.data.mask[x[0][0]:x[0][-1]] = True
    bands = bands[1:]
    fbands = fbands[1:]

    toplot = sp.data.copy()
    toplot[~continua] = np.nan
    sp.plotter.axis.plot(sp.xarr.value, toplot, color='r', alpha=0.5, linewidth=2, zorder=100)
    toplotn = sp.data.copy()
    toplotn[~continua] = np.nan
    sp.plotter.axis.plot(sp.xarr.value, toplotn, color='r', alpha=0.5, linewidth=2, zorder=100)
    pl.draw()
    pl.show()
    pl.draw()
    pl.show()
    sp.plotter.savefig("w51_spw{0}_contfind.png".format(spw))


    # these get written to the linechannels* files
    # then CASA:
    # These are the bands that should be flagged out
    print("Line bands to flag out:")
    print(bands +
          ',' + bands.replace("{0}:".format(spw),"{0}:".format(spw+4)))
    print()
    print(fbands +
          ',' + fbands.replace("{0}:".format(spw),"{0}:".format(spw+4)))

"""
# for just m
spw="1~256;523~1237;1260~2153;2172~2549;2819~3789;3803~5710;5720~7679"
# for n and m
spw='37~42;85~107;208~219;543~554;577~584;725~742;744~755;847~856;875~881;889~899;937~942;949~954;966~981;1039~1054;1083~1095;1106~1112;1121~1128;1130~1135;1175~1184;1228~1234;1291~1298;1392~1397;1400~1409;1414~1421;1440~1448;1468~1473;1485~1495;1506~1515;1518~1525;1575~1580;1585~1590;1598~1603;1626~1634;1638~1645;1656~1662;1680~1692;1697~1707;1802~1811;1861~1877;1921~1927;1934~1941;1966~1978;2002~2016;2025~2033;2035~2041;2090~2102;2124~2129;2192~2202;2209~2219;2223~2230;2239~2251;2508~2516;2926~2937;2953~2960;2979~2989;3287~3293;3345~3354;3360~3367;3372~3394;3413~3425;3450~3455;3479~3485;3541~3554;3687~3692;3704~3726;3735~3742;3775~3781;3935~3940;3953~3968;3978~3984;3996~4005;4019~4027;4265~4275;4306~4313;4315~4321;4709~4717;4766~4782;5003~5018;5112~5121;5217~5226;5306~5312;5376~5381;5384~5401;5417~5423;5425~5430;5452~5462;5509~5516;5814~5821;5936~5943;5954~5965;6007~6018;6112~6117;6133~6153;6156~6170;6192~6203;6271~6281;6283~6299;6320~6328;6339~6350;6366~6373;6392~6397;6399~6409;6474~6480;6507~6515;6518~6525;6679~6689;6748~6760;6778~6783;6786~6791;6811~6818;6850~6871;6894~6899;6920~6943;6959~6965;6979~6986;6997~7003;7061~7072;7087~7095;7110~7115;7175~7187;7195~7205;7214~7223;7228~7236;7239~7259;7264~7269;7306~7322;7357~7377;7424~7444;7504~7511;7575~7588'

# central pointing includes these fields:
field="3,66,67,68,77,78,79,87,88,89,99,100,101,102,111,112"

flagmanager(vis=finalvis, mode='save',
            versionname='before_cont_flags')


split(vis='calibrated.ms', outputvis='ptg3_spw1.ms', field='3', spw='1,5,9,13')
flagmanager(vis='ptg3_spw1.ms',
            mode='save',
            versionname='before_cont_flags')
flagmanager(vis='ptg3_spw1.ms', mode='restore', versionname='before_cont_flags')
#flagchannels=('0:128~159,0:227~529,0:594~707,0:757~762,0:770~833,0:860~866,0:1139~1167,0:1188~1222,0:1236~1278,0:1329~1346,0:1349~1388,0:1497~1502,0:1533~1568,0:1737~1776,0:1781~1788,0:1791~1799,0:1819~1858,0:1883~1896,0:1912~1919,0:2049~2056,0:2066~2074,0:2126~2186,0:2254~2364,0:2366~2411,0:2419~2451,0:2491~2497,0:2521~2531,0:2537~2826,0:2848~2915,0:2997~3063,0:3076~3254,0:3295~3333,0:3488~3531,0:3559~3590,0:3607~3616,0:3660~3683,0:3755~3761,0:3783~3810,0:3814~3850,0:3857~3898,0:3911~3923,0:4008~4016,0:4041~4056,0:4059~4068,0:4073~4263,0:4323~4331,0:4348~4552,0:4563~4697,0:4700~4707,0:4738~4762,0:4790~4983,0:4987~5001,0:5028~5058,0:5069~5100,0:5126~5149,0:5177~5187,0:5192~5203,0:5260~5282,0:5286~5298,0:5318~5341,0:5355~5360,0:5574~5594,0:5600~5609,0:5662~5669,0:5672~5724,0:5727~5734,0:5757~5785,0:5846~5883,0:5913~5934,0:6022~6074,0:6125~6131,0:6207~6238,0:6246~6263,0:6371~6385,0:6484~6503,0:6529~6544,0:6563~6651,0:6659~6675,0:6709~6739,0:6822~6845,0:6904~6909,0:6967~6981,0:7029~7036,0:7101~7107,0:7139~7170,0:7275~7300,0:7333~7354,0:7386~7421,0:7463~7483,0:7594~7633,1:128~159,1:227~529,1:594~707,1:757~762,1:770~833,1:860~866,1:1139~1167,1:1188~1222,1:1236~1278,1:1329~1346,1:1349~1388,1:1497~1502,1:1533~1568,1:1737~1776,1:1781~1788,1:1791~1799,1:1819~1858,1:1883~1896,1:1912~1919,1:2049~2056,1:2066~2074,1:2126~2186,1:2254~2364,1:2366~2411,1:2419~2451,1:2491~2497,1:2521~2531,1:2537~2826,1:2848~2915,1:2997~3063,1:3076~3254,1:3295~3333,1:3488~3531,1:3559~3590,1:3607~3616,1:3660~3683,1:3755~3761,1:3783~3810,1:3814~3850,1:3857~3898,1:3911~3923,1:4008~4016,1:4041~4056,1:4059~4068,1:4073~4263,1:4323~4331,1:4348~4552,1:4563~4697,1:4700~4707,1:4738~4762,1:4790~4983,1:4987~5001,1:5028~5058,1:5069~5100,1:5126~5149,1:5177~5187,1:5192~5203,1:5260~5282,1:5286~5298,1:5318~5341,1:5355~5360,1:5574~5594,1:5600~5609,1:5662~5669,1:5672~5724,1:5727~5734,1:5757~5785,1:5846~5883,1:5913~5934,1:6022~6074,1:6125~6131,1:6207~6238,1:6246~6263,1:6371~6385,1:6484~6503,1:6529~6544,1:6563~6651,1:6659~6675,1:6709~6739,1:6822~6845,1:6904~6909,1:6967~6981,1:7029~7036,1:7101~7107,1:7139~7170,1:7275~7300,1:7333~7354,1:7386~7421,1:7463~7483,1:7594~7633,2:128~159,2:227~529,2:594~707,2:757~762,2:770~833,2:860~866,2:1139~1167,2:1188~1222,2:1236~1278,2:1329~1346,2:1349~1388,2:1497~1502,2:1533~1568,2:1737~1776,2:1781~1788,2:1791~1799,2:1819~1858,2:1883~1896,2:1912~1919,2:2049~2056,2:2066~2074,2:2126~2186,2:2254~2364,2:2366~2411,2:2419~2451,2:2491~2497,2:2521~2531,2:2537~2826,2:2848~2915,2:2997~3063,2:3076~3254,2:3295~3333,2:3488~3531,2:3559~3590,2:3607~3616,2:3660~3683,2:3755~3761,2:3783~3810,2:3814~3850,2:3857~3898,2:3911~3923,2:4008~4016,2:4041~4056,2:4059~4068,2:4073~4263,2:4323~4331,2:4348~4552,2:4563~4697,2:4700~4707,2:4738~4762,2:4790~4983,2:4987~5001,2:5028~5058,2:5069~5100,2:5126~5149,2:5177~5187,2:5192~5203,2:5260~5282,2:5286~5298,2:5318~5341,2:5355~5360,2:5574~5594,2:5600~5609,2:5662~5669,2:5672~5724,2:5727~5734,2:5757~5785,2:5846~5883,2:5913~5934,2:6022~6074,2:6125~6131,2:6207~6238,2:6246~6263,2:6371~6385,2:6484~6503,2:6529~6544,2:6563~6651,2:6659~6675,2:6709~6739,2:6822~6845,2:6904~6909,2:6967~6981,2:7029~7036,2:7101~7107,2:7139~7170,2:7275~7300,2:7333~7354,2:7386~7421,2:7463~7483,2:7594~7633,3:128~159,3:227~529,3:594~707,3:757~762,3:770~833,3:860~866,3:1139~1167,3:1188~1222,3:1236~1278,3:1329~1346,3:1349~1388,3:1497~1502,3:1533~1568,3:1737~1776,3:1781~1788,3:1791~1799,3:1819~1858,3:1883~1896,3:1912~1919,3:2049~2056,3:2066~2074,3:2126~2186,3:2254~2364,3:2366~2411,3:2419~2451,3:2491~2497,3:2521~2531,3:2537~2826,3:2848~2915,3:2997~3063,3:3076~3254,3:3295~3333,3:3488~3531,3:3559~3590,3:3607~3616,3:3660~3683,3:3755~3761,3:3783~3810,3:3814~3850,3:3857~3898,3:3911~3923,3:4008~4016,3:4041~4056,3:4059~4068,3:4073~4263,3:4323~4331,3:4348~4552,3:4563~4697,3:4700~4707,3:4738~4762,3:4790~4983,3:4987~5001,3:5028~5058,3:5069~5100,3:5126~5149,3:5177~5187,3:5192~5203,3:5260~5282,3:5286~5298,3:5318~5341,3:5355~5360,3:5574~5594,3:5600~5609,3:5662~5669,3:5672~5724,3:5727~5734,3:5757~5785,3:5846~5883,3:5913~5934,3:6022~6074,3:6125~6131,3:6207~6238,3:6246~6263,3:6371~6385,3:6484~6503,3:6529~6544,3:6563~6651,3:6659~6675,3:6709~6739,3:6822~6845,3:6904~6909,3:6967~6981,3:7029~7036,3:7101~7107,3:7139~7170,3:7275~7300,3:7333~7354,3:7386~7421,3:7463~7483,3:7594~7633')
flagchannels=('0:88.5723813165~88.5799495711GHz,0:88.5965509037~88.6702803517GHz,0:88.6861492726~88.7137367813GHz,0:88.7259436435~88.7271643297GHz,0:88.7291174277~88.7444980741GHz,0:88.7510897797~88.7525546032GHz,0:88.819204071~88.8260399139GHz,0:88.831166796~88.8394674624GHz,0:88.8428853838~88.8531391481GHz,0:88.8655901476~88.8697404807GHz,0:88.8704728925~88.879994245GHz,0:88.9066052047~88.9078258909GHz,0:88.9153941455~88.9239389491GHz,0:88.9651981434~88.974719496GHz,0:88.9759401822~88.9776491429GHz,0:88.9783815547~88.9803346526GHz,0:88.9852173975~88.9947387501GHz,0:89.0008421812~89.0040159654GHz,0:89.0079221613~89.009631122GHz,0:89.0413689638~89.0430779246GHz,0:89.045519297~89.047472395GHz,0:89.0601675317~89.0748157664GHz,0:89.091417099~89.118272196GHz,0:89.1187604705~89.1297466465GHz,0:89.1316997444~89.1395121363GHz,0:89.1492776261~89.1507424495GHz,0:89.1566017434~89.1590431159GHz,0:89.1605079393~89.2310636031GHz,0:89.2364346225~89.2527918179GHz,0:89.2728110719~89.2889241301GHz,0:89.2920979143~89.3355543439GHz,0:89.3455639709~89.3548411862GHz,0:89.3926824592~89.4031803607GHz,0:89.4100162036~89.4175844581GHz,0:89.4217347913~89.4239320265GHz,0:89.4346740653~89.4402892219GHz,0:89.4578671035~89.459331927GHz,0:89.4647029464~89.471294652GHz,0:89.472271201~89.4810601418GHz,0:89.4827691025~89.4927787296GHz,0:89.4959525137~89.4988821607GHz,0:89.5196338265~89.5215869244GHz,0:89.5276903556~89.5313524142GHz,0:89.532084826~89.5342820612GHz,0:89.5355027474~89.5818888239GHz,0:89.5965370586~89.5984901566GHz,0:89.6026404897~89.6524444877GHz,0:89.6551299974~89.6878443882GHz,0:89.6885767999~89.6902857606GHz,0:89.6978540152~89.7037133091GHz,0:89.710549152~89.7576676402GHz,0:89.7586441892~89.7620621106GHz,0:89.7686538162~89.7759779336GHz,0:89.7786634433~89.7862316979GHz,0:89.7925792662~89.7981944228GHz,0:89.8050302657~89.8074716382GHz,0:89.8086923244~89.8113778341GHz,0:89.825293657~89.8306646764GHz,0:89.8316412254~89.8345708723GHz,0:89.8394536172~89.8450687739GHz,0:89.8484866953~89.8497073815GHz,0:89.9019527519~89.9068354968GHz,0:89.9083003203~89.9104975555GHz,0:89.9234368295~89.9251457902GHz,0:89.9258782019~89.9385733386GHz,0:89.9393057504~89.9410147111GHz,0:89.9466298677~89.9534657106GHz,0:89.9683580825~89.9773911606GHz,0:89.9847152779~89.9898421601GHz,0:90.0113262376~90.0240213743GHz,0:90.0364723738~90.0379371973GHz,0:90.0564916279~90.0640598825GHz,0:90.0660129804~90.0701633136GHz,0:90.096530136~90.0999480575GHz,0:90.1241176447~90.1287562524GHz,0:90.1351038207~90.1387658794GHz,0:90.1434044871~90.1648885646GHz,0:90.1668416626~90.1707478585GHz,0:90.1790485248~90.1863726421GHz,0:90.2066360335~90.2122511901GHz,0:90.2266552875~90.2278759738GHz,0:90.242035934~90.2454538554GHz,0:90.2571724432~90.2588814039GHz,0:90.2747503248~90.2762151483GHz,0:90.2840275401~90.2915957947GHz,0:90.3172302054~90.3233336365GHz,0:90.3313901656~90.3365170477GHz,0:90.3443294396~90.3528742431GHz,0:90.3631280074~90.3680107523GHz,0:90.3951099865~90.404631339GHz,1:88.5723813165~88.5799495711GHz,1:88.5965509037~88.6702803517GHz,1:88.6861492726~88.7137367813GHz,1:88.7259436435~88.7271643297GHz,1:88.7291174277~88.7444980741GHz,1:88.7510897797~88.7525546032GHz,1:88.819204071~88.8260399139GHz,1:88.831166796~88.8394674624GHz,1:88.8428853838~88.8531391481GHz,1:88.8655901476~88.8697404807GHz,1:88.8704728925~88.879994245GHz,1:88.9066052047~88.9078258909GHz,1:88.9153941455~88.9239389491GHz,1:88.9651981434~88.974719496GHz,1:88.9759401822~88.9776491429GHz,1:88.9783815547~88.9803346526GHz,1:88.9852173975~88.9947387501GHz,1:89.0008421812~89.0040159654GHz,1:89.0079221613~89.009631122GHz,1:89.0413689638~89.0430779246GHz,1:89.045519297~89.047472395GHz,1:89.0601675317~89.0748157664GHz,1:89.091417099~89.118272196GHz,1:89.1187604705~89.1297466465GHz,1:89.1316997444~89.1395121363GHz,1:89.1492776261~89.1507424495GHz,1:89.1566017434~89.1590431159GHz,1:89.1605079393~89.2310636031GHz,1:89.2364346225~89.2527918179GHz,1:89.2728110719~89.2889241301GHz,1:89.2920979143~89.3355543439GHz,1:89.3455639709~89.3548411862GHz,1:89.3926824592~89.4031803607GHz,1:89.4100162036~89.4175844581GHz,1:89.4217347913~89.4239320265GHz,1:89.4346740653~89.4402892219GHz,1:89.4578671035~89.459331927GHz,1:89.4647029464~89.471294652GHz,1:89.472271201~89.4810601418GHz,1:89.4827691025~89.4927787296GHz,1:89.4959525137~89.4988821607GHz,1:89.5196338265~89.5215869244GHz,1:89.5276903556~89.5313524142GHz,1:89.532084826~89.5342820612GHz,1:89.5355027474~89.5818888239GHz,1:89.5965370586~89.5984901566GHz,1:89.6026404897~89.6524444877GHz,1:89.6551299974~89.6878443882GHz,1:89.6885767999~89.6902857606GHz,1:89.6978540152~89.7037133091GHz,1:89.710549152~89.7576676402GHz,1:89.7586441892~89.7620621106GHz,1:89.7686538162~89.7759779336GHz,1:89.7786634433~89.7862316979GHz,1:89.7925792662~89.7981944228GHz,1:89.8050302657~89.8074716382GHz,1:89.8086923244~89.8113778341GHz,1:89.825293657~89.8306646764GHz,1:89.8316412254~89.8345708723GHz,1:89.8394536172~89.8450687739GHz,1:89.8484866953~89.8497073815GHz,1:89.9019527519~89.9068354968GHz,1:89.9083003203~89.9104975555GHz,1:89.9234368295~89.9251457902GHz,1:89.9258782019~89.9385733386GHz,1:89.9393057504~89.9410147111GHz,1:89.9466298677~89.9534657106GHz,1:89.9683580825~89.9773911606GHz,1:89.9847152779~89.9898421601GHz,1:90.0113262376~90.0240213743GHz,1:90.0364723738~90.0379371973GHz,1:90.0564916279~90.0640598825GHz,1:90.0660129804~90.0701633136GHz,1:90.096530136~90.0999480575GHz,1:90.1241176447~90.1287562524GHz,1:90.1351038207~90.1387658794GHz,1:90.1434044871~90.1648885646GHz,1:90.1668416626~90.1707478585GHz,1:90.1790485248~90.1863726421GHz,1:90.2066360335~90.2122511901GHz,1:90.2266552875~90.2278759738GHz,1:90.242035934~90.2454538554GHz,1:90.2571724432~90.2588814039GHz,1:90.2747503248~90.2762151483GHz,1:90.2840275401~90.2915957947GHz,1:90.3172302054~90.3233336365GHz,1:90.3313901656~90.3365170477GHz,1:90.3443294396~90.3528742431GHz,1:90.3631280074~90.3680107523GHz,1:90.3951099865~90.404631339GHz,2:88.5723813165~88.5799495711GHz,2:88.5965509037~88.6702803517GHz,2:88.6861492726~88.7137367813GHz,2:88.7259436435~88.7271643297GHz,2:88.7291174277~88.7444980741GHz,2:88.7510897797~88.7525546032GHz,2:88.819204071~88.8260399139GHz,2:88.831166796~88.8394674624GHz,2:88.8428853838~88.8531391481GHz,2:88.8655901476~88.8697404807GHz,2:88.8704728925~88.879994245GHz,2:88.9066052047~88.9078258909GHz,2:88.9153941455~88.9239389491GHz,2:88.9651981434~88.974719496GHz,2:88.9759401822~88.9776491429GHz,2:88.9783815547~88.9803346526GHz,2:88.9852173975~88.9947387501GHz,2:89.0008421812~89.0040159654GHz,2:89.0079221613~89.009631122GHz,2:89.0413689638~89.0430779246GHz,2:89.045519297~89.047472395GHz,2:89.0601675317~89.0748157664GHz,2:89.091417099~89.118272196GHz,2:89.1187604705~89.1297466465GHz,2:89.1316997444~89.1395121363GHz,2:89.1492776261~89.1507424495GHz,2:89.1566017434~89.1590431159GHz,2:89.1605079393~89.2310636031GHz,2:89.2364346225~89.2527918179GHz,2:89.2728110719~89.2889241301GHz,2:89.2920979143~89.3355543439GHz,2:89.3455639709~89.3548411862GHz,2:89.3926824592~89.4031803607GHz,2:89.4100162036~89.4175844581GHz,2:89.4217347913~89.4239320265GHz,2:89.4346740653~89.4402892219GHz,2:89.4578671035~89.459331927GHz,2:89.4647029464~89.471294652GHz,2:89.472271201~89.4810601418GHz,2:89.4827691025~89.4927787296GHz,2:89.4959525137~89.4988821607GHz,2:89.5196338265~89.5215869244GHz,2:89.5276903556~89.5313524142GHz,2:89.532084826~89.5342820612GHz,2:89.5355027474~89.5818888239GHz,2:89.5965370586~89.5984901566GHz,2:89.6026404897~89.6524444877GHz,2:89.6551299974~89.6878443882GHz,2:89.6885767999~89.6902857606GHz,2:89.6978540152~89.7037133091GHz,2:89.710549152~89.7576676402GHz,2:89.7586441892~89.7620621106GHz,2:89.7686538162~89.7759779336GHz,2:89.7786634433~89.7862316979GHz,2:89.7925792662~89.7981944228GHz,2:89.8050302657~89.8074716382GHz,2:89.8086923244~89.8113778341GHz,2:89.825293657~89.8306646764GHz,2:89.8316412254~89.8345708723GHz,2:89.8394536172~89.8450687739GHz,2:89.8484866953~89.8497073815GHz,2:89.9019527519~89.9068354968GHz,2:89.9083003203~89.9104975555GHz,2:89.9234368295~89.9251457902GHz,2:89.9258782019~89.9385733386GHz,2:89.9393057504~89.9410147111GHz,2:89.9466298677~89.9534657106GHz,2:89.9683580825~89.9773911606GHz,2:89.9847152779~89.9898421601GHz,2:90.0113262376~90.0240213743GHz,2:90.0364723738~90.0379371973GHz,2:90.0564916279~90.0640598825GHz,2:90.0660129804~90.0701633136GHz,2:90.096530136~90.0999480575GHz,2:90.1241176447~90.1287562524GHz,2:90.1351038207~90.1387658794GHz,2:90.1434044871~90.1648885646GHz,2:90.1668416626~90.1707478585GHz,2:90.1790485248~90.1863726421GHz,2:90.2066360335~90.2122511901GHz,2:90.2266552875~90.2278759738GHz,2:90.242035934~90.2454538554GHz,2:90.2571724432~90.2588814039GHz,2:90.2747503248~90.2762151483GHz,2:90.2840275401~90.2915957947GHz,2:90.3172302054~90.3233336365GHz,2:90.3313901656~90.3365170477GHz,2:90.3443294396~90.3528742431GHz,2:90.3631280074~90.3680107523GHz,2:90.3951099865~90.404631339GHz,3:88.5723813165~88.5799495711GHz,3:88.5965509037~88.6702803517GHz,3:88.6861492726~88.7137367813GHz,3:88.7259436435~88.7271643297GHz,3:88.7291174277~88.7444980741GHz,3:88.7510897797~88.7525546032GHz,3:88.819204071~88.8260399139GHz,3:88.831166796~88.8394674624GHz,3:88.8428853838~88.8531391481GHz,3:88.8655901476~88.8697404807GHz,3:88.8704728925~88.879994245GHz,3:88.9066052047~88.9078258909GHz,3:88.9153941455~88.9239389491GHz,3:88.9651981434~88.974719496GHz,3:88.9759401822~88.9776491429GHz,3:88.9783815547~88.9803346526GHz,3:88.9852173975~88.9947387501GHz,3:89.0008421812~89.0040159654GHz,3:89.0079221613~89.009631122GHz,3:89.0413689638~89.0430779246GHz,3:89.045519297~89.047472395GHz,3:89.0601675317~89.0748157664GHz,3:89.091417099~89.118272196GHz,3:89.1187604705~89.1297466465GHz,3:89.1316997444~89.1395121363GHz,3:89.1492776261~89.1507424495GHz,3:89.1566017434~89.1590431159GHz,3:89.1605079393~89.2310636031GHz,3:89.2364346225~89.2527918179GHz,3:89.2728110719~89.2889241301GHz,3:89.2920979143~89.3355543439GHz,3:89.3455639709~89.3548411862GHz,3:89.3926824592~89.4031803607GHz,3:89.4100162036~89.4175844581GHz,3:89.4217347913~89.4239320265GHz,3:89.4346740653~89.4402892219GHz,3:89.4578671035~89.459331927GHz,3:89.4647029464~89.471294652GHz,3:89.472271201~89.4810601418GHz,3:89.4827691025~89.4927787296GHz,3:89.4959525137~89.4988821607GHz,3:89.5196338265~89.5215869244GHz,3:89.5276903556~89.5313524142GHz,3:89.532084826~89.5342820612GHz,3:89.5355027474~89.5818888239GHz,3:89.5965370586~89.5984901566GHz,3:89.6026404897~89.6524444877GHz,3:89.6551299974~89.6878443882GHz,3:89.6885767999~89.6902857606GHz,3:89.6978540152~89.7037133091GHz,3:89.710549152~89.7576676402GHz,3:89.7586441892~89.7620621106GHz,3:89.7686538162~89.7759779336GHz,3:89.7786634433~89.7862316979GHz,3:89.7925792662~89.7981944228GHz,3:89.8050302657~89.8074716382GHz,3:89.8086923244~89.8113778341GHz,3:89.825293657~89.8306646764GHz,3:89.8316412254~89.8345708723GHz,3:89.8394536172~89.8450687739GHz,3:89.8484866953~89.8497073815GHz,3:89.9019527519~89.9068354968GHz,3:89.9083003203~89.9104975555GHz,3:89.9234368295~89.9251457902GHz,3:89.9258782019~89.9385733386GHz,3:89.9393057504~89.9410147111GHz,3:89.9466298677~89.9534657106GHz,3:89.9683580825~89.9773911606GHz,3:89.9847152779~89.9898421601GHz,3:90.0113262376~90.0240213743GHz,3:90.0364723738~90.0379371973GHz,3:90.0564916279~90.0640598825GHz,3:90.0660129804~90.0701633136GHz,3:90.096530136~90.0999480575GHz,3:90.1241176447~90.1287562524GHz,3:90.1351038207~90.1387658794GHz,3:90.1434044871~90.1648885646GHz,3:90.1668416626~90.1707478585GHz,3:90.1790485248~90.1863726421GHz,3:90.2066360335~90.2122511901GHz,3:90.2266552875~90.2278759738GHz,3:90.242035934~90.2454538554GHz,3:90.2571724432~90.2588814039GHz,3:90.2747503248~90.2762151483GHz,3:90.2840275401~90.2915957947GHz,3:90.3172302054~90.3233336365GHz,3:90.3313901656~90.3365170477GHz,3:90.3443294396~90.3528742431GHz,3:90.3631280074~90.3680107523GHz,3:90.3951099865~90.404631339GHz')
flagdata(vis='ptg3_spw1.ms', mode='manual',
          spw=flagchannels, flagbackup=False)
# this was caught in the original flagging flagdata(vis='ptg3_spw1.ms', mode='manual', flagbackup=False, timerange='2014/12/06/16:12:40~2014/12/06/16:13:20')

rm -rf phase.cal
rm -rf ptg3_spw1_*

split(vis='ptg3_spw1.ms',
      spw='',
      outputvis='ptg3_spw1_cont.ms',
      # number of channels to average together. change to appropriate value for
      # each spectral window in contspws (use listobs to find) and make sure to
      # use the native number of channels per SPW (that is, not the number of
      # channels left after flagging any lines)
      width=[80,],
      datacolumn='data')

clean(vis='ptg3_spw1_cont.ms', imagename='ptg3_spw1_cont_clean', field='',
      spw='', mode='mfs', niter=500, imsize=[256,256], cell='0.5arcsec',
      weighting='briggs', robust=0.5, pbcor=True, usescratch=True)

rm -rf phase.cal
gaincal(vis='ptg3_spw1_cont.ms', caltable="phase.cal", solint="30s",
        calmode="p", gaintype='G')      
plotcal(caltable="phase.cal", xaxis="time", yaxis="phase", subplot=331,
        iteration="antenna", plotrange=[0,0,-30,30], markersize=5, fontsize=10.0,
        figfile="ptg3_spw1_selfcal_phase_scan.png")
applycal(vis="ptg3_spw1_cont.ms", gaintable=["phase.cal"], interp="linear")
rm -rf ptg3_spw1_cont_selfcal*
split(vis="ptg3_spw1_cont.ms", outputvis="ptg3_spw1_cont_selfcal.ms", datacolumn='corrected')
clean(vis='ptg3_spw1_cont_selfcal.ms', imagename='ptg3_spw1_cont_selfcal_clean', field='',
      spw='', mode='mfs', niter=5000, imsize=[256,256], cell='0.5arcsec',
      weighting='briggs', robust=0.5, pbcor=True, usescratch=True)

"""

